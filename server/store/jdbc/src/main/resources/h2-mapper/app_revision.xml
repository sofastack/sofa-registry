<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.alipay.sofa.registry.jdbc.mapper.AppRevisionMapper">

    <resultMap type="com.alipay.sofa.registry.jdbc.domain.AppRevisionDomain" id="appRevisionResultMap">
        <id property="id" column="id" javaType="long" jdbcType="BIGINT"/>
        <result property="dataCenter" column="data_center" javaType="java.lang.String" jdbcType="VARCHAR"/>
        <result property="revision" column="revision" javaType="java.lang.String" jdbcType="VARCHAR"/>
        <result property="appName" column="app_name" javaType="java.lang.String" jdbcType="VARCHAR"/>
        <result property="clientVersion" column="client_version" javaType="java.lang.String" jdbcType="VARCHAR"/>
        <result property="baseParams" column="base_params" javaType="java.lang.String" jdbcType="LONGVARCHAR"/>
        <result property="serviceParams" column="service_params" javaType="java.lang.String" jdbcType="LONGVARCHAR"/>
        <result property="gmtCreate" column="gmt_create" javaType="java.util.Date" jdbcType="TIMESTAMP"/>
        <result property="gmtModify" column="gmt_modified" javaType="java.util.Date" jdbcType="TIMESTAMP"/>
    </resultMap>

    <select id="queryRevision" resultMap="appRevisionResultMap">
        <![CDATA[
         select * from app_revision
                          where data_center = #{dataCenter} and revision = #{revision}

        ]]>
    </select>

    <select id="batchQuery" parameterType="java.util.List" resultMap="appRevisionResultMap">
        select * from app_revision where data_center = #{dataCenter}
        <if test="revisions != null and revisions.size() > 0">
            and revision in
            <foreach collection="revisions" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>


    <update id="batchHeartbeat" parameterType="java.util.List">
        update app_revision set gmt_modified = CURRENT_TIMESTAMP
        where data_center=#{dataCenter}
        <if test="revisions != null and revisions.size() > 0">
            and revision in
            <foreach collection="revisions" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </update>


   <select id="batchCheck" parameterType="java.util.List" resultType="java.lang.String">
        select revision from app_revision where data_center = #{dataCenter}
        <if test="revisions != null and revisions.size() > 0">
            and revision in
            <foreach collection="revisions" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <select id="listRevisions" resultMap="appRevisionResultMap">
    <![CDATA[
        select * from app_revision where data_center = #{dataCenter} and id > #{afterId} order by id limit #{limit}
    ]]>
    </select>

    <update id="heartbeat">
        update app_revision set gmt_modified=CURRENT_TIMESTAMP  where data_center = #{dataCenter}
        and revision=#{revision}
        and deleted = '0'
    </update>

    <insert id="replace" parameterType="com.alipay.sofa.registry.jdbc.domain.AppRevisionDomain">
        delete from app_revision where data_center=#{dataCenter} and revision=#{revision};
        insert into app_revision (
               data_center,
               revision,
               app_name,
               client_version,
               base_params,
               service_params,
               deleted,
               gmt_create,
               gmt_modified
        )
        values (
               #{dataCenter},
               #{revision},
               #{appName},
               #{clientVersion},
               #{baseParams},
               #{serviceParams},
               #{deleted},
               CURRENT_TIMESTAMP,
               CURRENT_TIMESTAMP
        ) on duplicate key update deleted = #{deleted};
    </insert>
    <select id="getExpired" resultMap="appRevisionResultMap">
    <![CDATA[
        select * from app_revision where data_center=#{dataCenter} and gmt_modified < #{beforeTime} and deleted='0'
        limit #{limit}
    ]]>
    </select>
    <delete id="cleanDeleted">
        <![CDATA[
        delete from app_revision where data_center=#{dataCenter} and gmt_modified < #{beforeTime} and deleted='1'
        limit #{limit}
        ]]>
    </delete>

</mapper>